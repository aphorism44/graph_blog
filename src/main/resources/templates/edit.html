<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
>
<head>
    <meta charset="UTF-8">
    <title>Life Fractal</title>
    <script src="/tinymce/tinymce.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
          crossorigin="anonymous">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Fractal Blog - Editor</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/edit}">Entry Editor</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/edit}">Entry List</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/logout}">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <div class="row">
        <h1> Entry Editor </h1>
    </div>
    <h1>Edit Entry</h1>
	<form id="entryForm" action="#" th:action="@{/entries/save}" method="post" th:object="${entry}">
    <!-- Entry ID (hidden input for tracking) -->
    <input type="hidden" id="entryId" name="id" th:field="*{id}" />

    <!-- Title Field -->
    <label for="title">Title:</label>
    <input type="text" id="title" name="title" th:field="*{title}" required />
    <br><br>

    <!-- Content Field -->
    <label for="text">Content:</label>
    <textarea id="content" name="text" th:field="*{text}"></textarea>
    <br><br>

    <!-- Navigation Buttons -->
    <div>
        <!-- Previous Button -->
        <button type="button" id="prevButton" th:if="${entry.previousEntryId != null}"
                onclick="navigateToEntry('previous')">Previous</button>
        
        <!-- Save Button -->
        <button type="submit">Save</button>
        
        <!-- Next Button -->
        <button type="button" id="nextButton" onclick="navigateToEntry('next')">Next</button>
    </div>
</form>

<script>
    // Initialize TinyMCE
    tinymce.init({
        selector: '#content',
        plugins: 'autolink lists link charmap preview',
        toolbar: 'undo redo | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link',
        menubar: false,
        height: 300
    });

    // Navigate to the previous or next entry
    function navigateToEntry(direction) {
        // Post navigation request to backend, which will update session and reload
        $.post('/entries/navigate', { direction: direction }, function () {
            window.location.reload(); // Reload page to reflect session-updated entry
        });
    }
    
    // AJAX Submission for Save Button
    $('#saveButton').on('click', function () {
        // Prepare JSON payload
        const entry = {
            id: $('#entryId').val(),
            title: $('#title').val(),
            text: tinymce.get("content").getContent() // Get content from TinyMCE editor
        };

        // Send AJAX POST request
        $.ajax({
            url: '/entries/save',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(entry),
            success: function (response) {
                alert("Entry saved successfully!");
            },
            error: function (xhr, status, error) {
                alert("An error occurred while saving the entry: " + error);
            }
        });
    });
</script>

</div>
</body>
</html>